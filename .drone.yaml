---
kind: pipeline
type: kubernetes
name: git-tools

steps:

- name: Prepare Credentials
  image: alpine:3.14
  environment:
    PLUGIN_TAGS: v0.1,latest
    KANIKO_CRED:
      from_secret: KANIKO_CRED
    PLUGIN_USERNAME: "rbc_robot$drone"
    PLUGIN_DOCKERFILE: "Dockerfile"
    REGISTRY: "core-harbor.popoint.com.tw"
  volumes:
  - name: cred
    path: /tmp/.docker
  commands:
  - printenv
  - cat << EOF > /tmp/.docker/config.json
    {
	    "auths": {
	    	"https://${REGISTRY}": {
	    		"auth": "${KANIKO_CRED}"
        }
	    }
    }
    EOF
  - cat /tmp/.docker/config.json


- name: Build and Push docker image
  image: core-harbor.popoint.com.tw/library/drone-kaniko:v0.1
  volumes:
  - name: cred
    path: /kaniko/.docker  
  environment:
    PLUGIN_TAGS: v0.1,v0.1-${DRONE_COMMIT_SHA:0:8}-${DRONE_BUILD_NUMBER},latest
    PLUGIN_PASSWORD:
      from_secret: HARBOR_TOKEN_ORIGIN
    PLUGIN_USERNAME: "rbc_robot$drone"
    PLUGIN_DOCKERFILE: "Dockerfile"
    PLUGIN_REPO: "core-harbor.popoint.com.tw/popoint-dev/git-kustomize"

- name: Send telegram notification
  image: appleboy/drone-telegram
  settings:
    token:
      from_secret: bot-token
    to:
      from_secret: chatid
    message: >
      {{#success build.status}}
       {{repo.name}} build {{build.number}} succeeded.
      Commit sha: {{commit.sha}}.
      Check from {{build.link}}.
      Good job.
      {{else}}
        {{repo.name}} build {{build.number}} failed.
      Commit sha: {{commit.sha}}.
      Check from {{build.link}}.
      Fix it please.
      {{/success}}      
  when:
    status:
    - success
    - failure

volumes:
- name: cred
  temp: {}